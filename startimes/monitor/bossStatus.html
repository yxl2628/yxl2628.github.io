<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>四达时代网络监控-OTT</title>
  <link rel="stylesheet" href="./css/bossStatus.css?version=1528769604144">
  <link rel="stylesheet" href="./css/boosFont/bossIconfont.css?version=1528769604144">
  <script src="./js/jquery.min.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/grafana.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/influxdb.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/template-web.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/moment.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/moment-timezone-with-data.min.js?version=1528769604144" charset="utf-8"></script>
  <script src="./config/boss-contry.js?version=1528769604144" charset="utf-8"></script>
</head>

<body>
  <div class="bossPage">
    <div class="sassList">
      <div class="listPanel" style="margin-top:55px;">
        <div class="sassTitle">
          <div class="title">
            <div class="titleImage">
              <img src="img/boss/Cloud%20server.png" alt="">
            </div>
            <div class="titleName">BOSS</div>
          </div>
        </div>
        <ul class="sassContent">
          <li onclick="goto('http://52.31.253.254:8000/d/000000006/bosswei-fu-wu-jian-kong?orgId=1')">
            <p>微服务状态</p>
            <p class="sassContentFirstList"><span id="bossSuccess"></span>/<span id="bossTotal"></span></p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/000000018/nginxri-zhi-jian-kong?orgId=1')">
            <p id="systemStatus">系统接入状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont">系统请求数:<span id="systemTotal"></span></p>
              <p class="sassLiContentFont">请求错误率:<span id="systemPersent"></span>%</p>
            </div>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/XEe6zkHiz/cazhi-ling-jian-kong?orgId=1')">
            <p id="caStatus">CA指令状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont">堆积指令:<span id="caTotal"></span></p>
              <p class="sassLiContentFont">失败指令:<span id="caError"></span></p>
            </div>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/n-EAGGOiz/duan-xin-xia-fa-jian-kong')">
            <p id="msgStatus">短信下发状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont single">失败短信：<span id="msgError"></span></p>
            </div>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/0WSA7Gdmk/zhi-fu-dui-lie-jian-kong')">
            <p id="payStatus">支付状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont single">最近30分钟支付：<span id="payTotal"></span></p>
            </div>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/0YjCC7Fik/bossying-ye-zhuang-tai?orgId=1')">
            <p id="openStatus">营业状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont single">最近30分钟：<span id="openTotal"></span></p>
            </div>
          </li>
        </ul>
        <div class='sassPlaceHolder'></div>
      </div>
      <div class="listPanel">
        <div class="iaasTitle">
          <p></p>
        </div>
        <ul class="iaasContent">
          <li onclick="goto('http://52.31.253.254:8000/d/000000019/ec2jian-kong-cpuandmem?orgId=1')">
            <i class="iconfont icon-dec2"></i>
            <p>云主机</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/000000001/k8sji-qun-jian-kong?orgId=1')">
            <i class="iconfont icon-KS"></i>
            <p>集群平台</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/000000011/rdsjian-kong?orgId=1')">
            <i class="iconfont icon-database"></i>
            <p>数据库</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/000000010/redisjian-kong?orgId=1')">
            <i class="iconfont icon-yunxiazai1"></i>
            <p>系统缓存</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/iBHoTQSmz/sqsjian-kong?refresh=5m&orgId=1')">
            <i class="iconfont icon-xiaoxiduilieMQ"></i>
            <p>消息队列</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/8iF4qnKik/xiao-xi-tong-zhi?orgId=1')">
            <i class="iconfont icon-xiaoxiguanli"></i>
            <p>消息通知</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/EHD5-fDmz/zhi-cheng-fu-wu-jian-kong?orgId=1')">
            <i class="iconfont icon-jingxiangku"></i>
            <p>发布镜像库</p>
          </li onclick="goto('http://52.31.253.254:8000/d/EHD5-fDmz/zhi-cheng-fu-wu-jian-kong?orgId=1')">
          <li>
            <i class="iconfont icon-peizhiguanli"></i>
            <p>配置管理</p>
          </li>
          <li onclick="goto('http://52.31.253.254:8000/d/EHD5-fDmz/zhi-cheng-fu-wu-jian-kong?orgId=1')">
            <i class="iconfont icon-shujuku"></i>
            <p>数据备份</p>
          </li>
        </ul>
        <div class="iassPlaceHolder">
        </div>
      </div>
    </div>
    <div class="cloudImgWrap">
      <div class="cloudline">
        <div class="line"></div>
      </div>
      <div class="cloud"></div>
      <div class="vpn">VPN</div>
      <div class="stat">
        <div class="stat-item">
          <div class="title">运营国家</div>
          <div class="num" id="countryNum"></div>
        </div>
        <div class="stat-item">
          <div class="title">在线终端</div>
          <div class="num" id="clientNum"></div>
        </div>
      </div>
      <div class="wrap-bg"></div>
      <div class="wrap-icon">
        <span><i></i></span>
      </div>
      <div class="wrap-bg wrap-bg2"></div>
      <div class="wrap-icon wrap-icon2">
        <span><i></i></span>
      </div>
      <div class="wrap-bg wrap-bg3"></div>
      <div class="wrap-icon wrap-icon3">
        <span><i></i></span>
      </div>
      <div class="countryLine">
        <div class="itemLine itemLine1"></div>
        <div class="itemLine itemLine2"></div>
        <div class="itemLine itemLine3"></div>
        <div class="itemLine itemLine4"></div>
      </div>
    </div>
  </div>
  <div class="countryGroupWrap">
    <div class="countryGroup">
      <div class="countryTitle">
        <p>东非</p>
      </div>
      <div id="eastAfrica">
      </div>
    </div>
    <div class="countryGroup">
      <div class="countryTitle">
        <p>西非</p>
      </div>
      <div id="westAfrica">
      </div>
    </div>
    <div class="countryGroup">
      <div class="countryTitle">
        <p>中非</p>
      </div>
      <div id="centerAfrica">
      </div>
    </div>
    <div class="countryGroup">
      <div class="countryTitle">
        <p>南非</p>
      </div>
      <div id="southAfirca">
      </div>
    </div>
  </div>
  </div>
  <script id="countryTpl" type="text/html">
    <div class="countryItem" onclick="goto('{{url}}')">
      <div class="countryImg">
        <img src="img/country/{{enName}}.jpg" alt="">
      </div>
      <div class="countryName">
        <div class="name">{{name}}</div>
      </div>
      <div class="countryTime">
        {{time}}
      </div>
      <div class="countryStatus">
        <div class="light {{if status=='none'}}none{{else if status=='good'}}good{{else}}error{{/if}}-light"></div>
      </div>
    </div>
  </script>
  <script type="text/javascript">
    var grafana_server = new $.jqgrafana(),
      influxdb_server = new $.jqinfluxdb(),
      bossStatus = {},
      color = ['#30af81', '#d1d41a', '#ff1d04']
    moment.locale('zh_cn')
    $('#countryNum').html(westAfrica.length + eastAfrica.length + centerAfrica.length + southAfirca.length)
    task()
    setInterval(function() {
      task()
    }, 60000)
    // 总的任务调度
    function task() {
      getBossStatus()
      getInfluxDB()
      getCountryStatus()
      getServiceStatus()
    }

    function getInfluxDB() {
      // 系统请求数
      influxdb_server.queryData('SELECT last("number") FROM "boss-access" WHERE   time >= now() - 30m GROUP BY "httpcode" ', function(res) {
        handelerInfluxDBValue('systemTotal', res.results[0].series)
      })
      // 错误率
      influxdb_server.queryData('SELECT last("number") FROM "boss-access" WHERE  "httpcode" = \'404\' AND time >= now() - 30m', function(a1) {
        influxdb_server.queryData('SELECT last("number") FROM "boss-access" WHERE  "httpcode" = \'500\' AND time >= now() - 30m', function(a2) {
          influxdb_server.queryData('SELECT last("number") FROM "boss-access" WHERE   time >= now() - 30m GROUP BY "httpcode" ', function(a3) {
            var total404 = a1.results[0].series, total500 = a2.results[0].series, total = a3.results[0].series, result = {values:[['time', 0]]}
            total404 = total404 === undefined ? 0 : total404[0].values[0][1]
            total500 = total500 === undefined ? 0 : total500[0].values[0][1]
            total = total === undefined ? 0 : total[0].values[0][1]
            if (total != 0) {
              var errorPersent = ((total404 + total500)/total)*100
              result.values = [['time', parseInt(errorPersent*100)/100]]
            }
            handelerInfluxDBValue('systemPersent', [result])
          })
        })
      })
      // 失败指令
      influxdb_server.queryData('SELECT last("VALUE") FROM "send_fail_equipment_instruction" WHERE time > now() - 30m GROUP BY "COMPANY_ID"', function(res) {
        handelerInfluxDBValue('caError', res.results[0].series)
      })
      // 堆积指令
      influxdb_server.queryData('SELECT last("local_file_number") FROM "conax_proxy_py" WHERE  time > now() - 30m', function(res) {
        handelerInfluxDBValue('caTotal', res.results[0].series)
      })
      // 失败短信
      influxdb_server.queryData('SELECT last("VALUE")  FROM "send_message" WHERE time > now() - 30m GROUP BY "COMPANY_ID", "LAST_SEND_INFO"', function(res) {
        handelerInfluxDBValue('msgError', res.results[0].series)
      })
      // 支付状态
      influxdb_server.queryData('SELECT sum("VALUE") FROM "payer_transactions" WHERE ("STATUS" = \'成功\') AND time >= now() - 30m GROUP BY "COMPANY_CODE"', function(res) {
        handelerInfluxDBValue('payTotal', res.results[0].series)
      })
      // 营业状态
      influxdb_server.queryData('SELECT sum("VALUE") FROM "accept_sheets" WHERE ("STATUS" = \'已完工\') AND time >= now() - 30m GROUP BY "COMPANY_CODE"', function(res) {
        handelerInfluxDBValue('openTotal', res.results[0].series)
      })
      // 在线终端数
      influxdb_server.queryData('SELECT sum("VALUE") FROM "login_users" WHERE ("TYPE" = \'Employee\' or "TYPE" = \'Partner Staff\') AND  time > now() - 30m', function(res) {
        $('#clientNum').text(res.results[0].series[0].values[0][1])
      })
    }
    function handelerInfluxDBValue(id, list) {
      var total = 0
      if (list !== undefined) {
        list.forEach(function(serie) {
          serie.values.forEach(function(val) {
            total += val[1]
          })
        })
      }

      $('#' + id).text(total)
      var $parent = $('#' + id).parent()

      if (['payTotal', 'openTotal','systemTotal'].indexOf(id) >= 0) {
        if (total < 0) {
          $parent.css('color', color[2])
        } else if (total >= 0 && total < 5) {
          $parent.css('color', color[1])
        } else {
          $parent.css('color', color[0])
        }
      } else if (id == 'systemPersent') {
        if (total < 1) {
          $parent.css('color', color[0])
        } else if (total >= 1 && total < 5) {
          $parent.css('color', color[1])
        } else {
          $parent.css('color', color[2])
        }
      } else {
        if (total == 0) {
          $parent.css('color', color[0])
        } else if (total > 0 && total < 5) {
          $parent.css('color', color[1])
        } else {
          $parent.css('color', color[2])
        }
      }

    }
    // 获取boss各项服务状态
    function getBossStatus() {
      grafana_server.queryData('alerts?state=all', 'GET', null, function(res) {
        bossStatus = {}
        res.forEach(function(item) {
          if (item.name.indexOf('微服务状态-EC2-BOSS') >= 0) {
            if (bossStatus.status == undefined) {
              bossStatus.status = {
                success: 0,
                total: 0
              }
            }
            bossStatus.status.total += 1
            if (item.state == 'ok') {
              bossStatus.status.success += 1
            }
          } else if (item.name.indexOf('业务状态-BOSS-CA-') >= 0) {
            if (bossStatus.ca == undefined) {
              bossStatus.ca = {
                success: 0,
                total: 0
              }
            }
            bossStatus.ca.total += 1
            if (item.state == 'ok') {
              bossStatus.ca.success += 1
            }
          } else if (item.name.indexOf('业务状态-BOSS-短信-') >= 0) {
            if (bossStatus.msg == undefined) {
              bossStatus.msg = {
                success: 0,
                total: 0
              }
            }
            bossStatus.msg.total += 1
            if (item.state == 'ok') {
              bossStatus.msg.success += 1
            }
          } else if (item.name.indexOf('业务状态-BOSS-支付-') >= 0) {
            if (bossStatus.pay == undefined) {
              bossStatus.pay = {
                success: 0,
                total: 0
              }
            }
            bossStatus.pay.total += 1
            if (item.state == 'ok') {
              bossStatus.pay.success += 1
            }
          } else if (item.name.indexOf('基础服务-系统缓存-') >= 0) {
            if (bossStatus.cache == undefined) {
              bossStatus.cache = {
                success: 0,
                total: 0
              }
            }
            bossStatus.cache.total += 1
            if (item.state == 'ok') {
              bossStatus.cache.success += 1
            }
          } else if (item.name.indexOf('基础服务-EC2HOST-') >= 0) {
            if (bossStatus.EC2 == undefined) {
              bossStatus.EC2 = {
                success: 0,
                total: 0
              }
            }
            bossStatus.EC2.total += 1
            if (item.state == 'ok') {
              bossStatus.EC2.success += 1
            }
          } else if (item.name.indexOf('基础服务-BOSSDB') >= 0) {
            if (bossStatus.BOSSDB == undefined) {
              bossStatus.BOSSDB = {
                success: 0,
                total: 0
              }
            }
            bossStatus.BOSSDB.total += 1
            if (item.state == 'ok') {
              bossStatus.BOSSDB.success += 1
            }
          } else if (item.name.indexOf('基础服务-K8s') >= 0) {
            if (bossStatus.K8s == undefined) {
              bossStatus.K8s = {
                success: 0,
                total: 0
              }
            }
            bossStatus.K8s.total += 1
            if (item.state == 'ok') {
              bossStatus.K8s.success += 1
            }
          } else {
            // console.log(item)
          }
        })
        $('#bossTotal').text(bossStatus.status.total)
        $('#bossSuccess').text(bossStatus.status.success)
        if (bossStatus.EC2.success === bossStatus.EC2.total) {
          $('.icon-dec2').css('color', color[0])
        } else {
          $('.icon-dec2').css('color', color[2])
        }
        if (bossStatus.K8s.success === bossStatus.K8s.total) {
          $('.icon-KS').css('color', color[0])
        } else {
          $('.icon-KS').css('color', color[2])
        }
        if (bossStatus.BOSSDB.success === bossStatus.BOSSDB.total) {
          $('.icon-database').css('color', color[0])
        } else {
          $('.icon-database').css('color', color[2])
        }
        if (bossStatus.cache.success === bossStatus.cache.total) {
          $('.icon-yunxiazai1').css('color', color[0])
        } else {
          $('.icon-yunxiazai1').css('color', color[2])
        }
        if (bossStatus.msg.success === bossStatus.msg.total) {
          $('.icon-xiaoxiduilieMQ').css('color', color[0])
        } else {
          $('.icon-xiaoxiduilieMQ').css('color', color[2])
        }
      })
    }
    // 渲染国家列表
    function getCountryStatus() {
      handlerCountry('westAfrica', westAfrica)
      handlerCountry('eastAfrica', eastAfrica)
      handlerCountry('centerAfrica', centerAfrica)
      handlerCountry('southAfirca', southAfirca)
    }

    function handlerCountry(id, list) {
      $('#' + id).html('')
      list.forEach(function(item) {
        if (item.name.split('').length <= 3) {
          item.name = item.name.split('').join(' ')
        }
        item.time = moment().tz(item.timezone).format('HH:mm')
        if (item.uid != undefined) {
          grafana_server.queryData('dashboards/uid/' + item.uid, 'GET', null, function(res) {
            item.url = grafana_server.getOptions('url').replace('api/', res.meta.url)
            item.id = res.dashboard.id
            grafana_server.queryData('alerts?dashboardId=' + item.id, 'GET', null, function(res) {
              item.status = 'good'
              res.forEach(function(_val) {
                if (_val.state != 'ok') {
                  item.status = 'bad'
                }
              })
              $('#' + id).append(template('countryTpl', item))
            })
          })
        } else {
          item.status = 'none'
          $('#' + id).append(template('countryTpl', item))
        }
      })
    }

    function getServiceStatus() {
      serviceList.forEach(function(item) {
        grafana_server.queryData('dashboards/uid/' + item.uid, 'GET', null, function(res) {
          item.url = grafana_server.getOptions('url').replace('api/', res.meta.url)
          item.id = res.dashboard.id
          grafana_server.queryData('alerts?dashboardId=' + item.id, 'GET', null, function(res) {
            var serviceColor = $('#' + item.name).css('color')
            res.forEach(function(_val) {
              if (_val.state != 'ok') {
                serviceColor = color[2]
              }
            })
            $('#' + item.name).css('color', serviceColor)
          })
        })
      })
    }

    function goto(url) {
      if (url !== undefined) {
        location.href = url
      }
    }
  </script>
</body>

</html>
